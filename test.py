
import pymongo
import json

import datetime
import time

myclient = pymongo.MongoClient("mongodb://localhost:27017/")
mydb = myclient["jugidb"]
registered_users = mydb["users"]
try_counters = mydb["try_counter"]
registered_wariors = mydb["wariors"]
battle = mydb["battle"]
settings    = mydb["settings"]
competition = mydb["competition"]
USERS = []

def getSetting(code: str):
    """ –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ """
    result = settings.find_one({'code': code})
    if (result):
        return result.get('value') 

def setSetting(code: str, value: str):
    """ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ """
    myquery = { "code": code }
    newvalues = { "$set": { "value": value.toJSON() } }
    settings.update_one(myquery, newvalues)

#myquery = { "code": 'REPORT_KILLERS' }
#newvalues = { "$set": { "value": {'from_date': datetime.datetime(2019, 10, 27).timestamp(), 'to_date': None}} } 
#u = settings.update_one(myquery, newvalues)

setting = getSetting('REPORT_KILLERS')
from_date = setting.get('from_date')
to_date = setting.get('to_date')

#if (not from_date):
from_date = (datetime.datetime(2019, 1, 1) + datetime.timedelta(minutes=180)).timestamp() 

if (not to_date):
    to_date = (datetime.datetime.now() + datetime.timedelta(minutes=180)).timestamp()

print(from_date)
print(to_date)

# registered_users.insert_one({'accuracy': '120', 'agility': '475', 'armor': '270', 'band': '–ê—Ä—Ç—Ö–∞—É—Å', 'charisma': '151', 'damage': '1014', 'dzen': 0, 'force': '670', 'fraction': '‚öôÔ∏è–£–±–µ–∂–∏—â–µ 4', 'health': '675', 'hunger': '13', 'loacation': 'üë£0–∫–º.', 'login': 'XyTop_2', 'name': 'Ark–∞', 'stamina': '18', 'timeBan': None, 'timeUpdate': 1571635229, 'status': None})

for x in battle.find({
                                    "$and" : [
                                        { 
                                            "date": {
                                                '$gte': from_date,
                                                '$lt': to_date
                                                    }       
                                        },
                                        {
                                            "band": '–ê—Ä—Ç—Ö–∞—É—Å'   
                                        }]
                                }):                                                 
    print(x)

# competition.remove()
# competition.insert_one({'login': 'GonzikBenzyavsky', 'chat': 497065022, 'date': 1571401667.250403, 'state': 'READY', 'name': '–ö–∏—Ä–∏–ª–ª', 'health': '665', 'damage': '995', 'armor': '227', 'accuracy': '120', 'agility': '452', 'charisma': '151', 'bm': 2383, 'strategy': ['‚öî –ù–∞–ø–∞–¥–µ–Ω–∏–µ', 'üòé –ü—Ä–æ–≤–æ–∫–∞—Ü–∏—è', 'üõ° –ó–∞—â–∏—Ç–∞'], 'band':'üé© –ì–æ—Ä–æ–¥—Å–∫–∏–µ'})
# competition.insert_one({'login': 'GonzikBenzyavsky1', 'chat': 497065022, 'date': 1571401667.250403, 'state': 'READY', 'name': '–°–µ—Ä–≥–µ–π', 'health': '665', 'damage': '1000', 'armor': '150', 'accuracy': '120', 'agility': '452', 'charisma': '151', 'bm': 2383, 'strategy': ['‚öî –ù–∞–ø–∞–¥–µ–Ω–∏–µ', 'üòé –ü—Ä–æ–≤–æ–∫–∞—Ü–∏—è', 'üõ° –ó–∞—â–∏—Ç–∞'], 'band':'üé© –ì–æ—Ä–æ–¥—Å–∫–∏–µ'})
# competition.insert_one({'login': 'GonzikBenzyavsky2', 'chat': 497065022, 'date': 1571401667.250403, 'state': 'READY', 'name': '–î–º–∏—Ç—Ä–∏–π', 'health': '665', 'damage': '500', 'armor': '227', 'accuracy': '120', 'agility': '452', 'charisma': '151', 'bm': 2383, 'strategy': ['‚öî –ù–∞–ø–∞–¥–µ–Ω–∏–µ', 'üòé –ü—Ä–æ–≤–æ–∫–∞—Ü–∏—è', 'üõ° –ó–∞—â–∏—Ç–∞'], 'band':'üé© –ì–æ—Ä–æ–¥—Å–∫–∏–µ'})
# competition.insert_one({'login': 'GonzikBenzyavsky3', 'chat': 497065022, 'date': 1571401667.250403, 'state': 'READY', 'name': '–ò–≤–∞–Ω', 'health': '665', 'damage': '700', 'armor': '100', 'accuracy': '120', 'agility': '452', 'charisma': '151', 'bm': 2383, 'strategy': ['‚öî –ù–∞–ø–∞–¥–µ–Ω–∏–µ', 'üòé –ü—Ä–æ–≤–æ–∫–∞—Ü–∏—è', 'üõ° –ó–∞—â–∏—Ç–∞'], 'band':'üé© –ì–æ—Ä–æ–¥—Å–∫–∏–µ'})
#competition.insert_one({'login': 'GonzikBenzyavsky4', 'chat': 497065022, 'date': 1571401667.250403, 'state': 'READY', 'name': '–ü–µ—Ç—Ä', 'health': '665', 'damage': '650', 'armor': '200', 'accuracy': '120', 'agility': '452', 'charisma': '151', 'bm': 2383, 'strategy': ['‚öî –ù–∞–ø–∞–¥–µ–Ω–∏–µ', 'üòé –ü—Ä–æ–≤–æ–∫–∞—Ü–∏—è', 'üõ° –ó–∞—â–∏—Ç–∞'], 'band':'üé© –ì–æ—Ä–æ–¥—Å–∫–∏–µ'})
# competition.insert_one({'login': 'XyTop_2', 'chat': 497065022, 'date': 1571401667.250403, 'state': 'READY', 'name': 'Arka', 'health': '665', 'damage': '1100', 'armor': '250', 'accuracy': '120', 'agility': '452', 'charisma': '151', 'bm': 2383, 'strategy': ['üõ° –ó–∞—â–∏—Ç–∞', '‚öî –ù–∞–ø–∞–¥–µ–Ω–∏–µ', 'üòé –ü—Ä–æ–≤–æ–∫–∞—Ü–∏—è'], 'band':'üêá –ú–µ—Ä—Ç–≤—ã–µ –∫—Ä–æ–ª–∏–∫–∏'})
# competition.insert_one({'login': 'XyTop_21', 'chat': 497065022, 'date': 1571401667.250403, 'state': 'READY', 'name': 'Mark', 'health': '665', 'damage': '200', 'armor': '100', 'accuracy': '120', 'agility': '452', 'charisma': '151', 'bm': 2383, 'strategy': ['üòé –ü—Ä–æ–≤–æ–∫–∞—Ü–∏—è', 'üõ° –ó–∞—â–∏—Ç–∞', '‚öî –ù–∞–ø–∞–¥–µ–Ω–∏–µ'], 'band':'üêá –ú–µ—Ä—Ç–≤—ã–µ –∫—Ä–æ–ª–∏–∫–∏'})
# competition.insert_one({'login': 'XyTop_22', 'chat': 497065022, 'date': 1571401667.250403, 'state': 'READY', 'name': 'Born', 'health': '665', 'damage': '500', 'armor': '100', 'accuracy': '120', 'agility': '452', 'charisma': '151', 'bm': 2383, 'strategy': ['üõ° –ó–∞—â–∏—Ç–∞', 'üòé –ü—Ä–æ–≤–æ–∫–∞—Ü–∏—è', '‚öî –ù–∞–ø–∞–¥–µ–Ω–∏–µ'], 'band':'üêá –ú–µ—Ä—Ç–≤—ã–µ –∫—Ä–æ–ª–∏–∫–∏'})
#competition.insert_one({'login': 'XyTop_23', 'chat': 497065022, 'date': 1571401667.250403, 'state': 'READY', 'name': 'Corn', 'health': '665', 'damage': '900', 'armor': '135', 'accuracy': '120', 'agility': '452', 'charisma': '151', 'bm': 2383, 'strategy': ['üõ° –ó–∞—â–∏—Ç–∞', '‚öî –ù–∞–ø–∞–¥–µ–Ω–∏–µ', 'üòé –ü—Ä–æ–≤–æ–∫–∞—Ü–∏—è'], 'band':'üêá –ú–µ—Ä—Ç–≤—ã–µ –∫—Ä–æ–ª–∏–∫–∏'})



# registered_users.remove()  

# competition.insert_one({'login': 'GonzikBenzyavsky', 'chat': 497065022, 'date': 1571771071.300144, 'state': 'READY', 'name': '–ö–∏—Ä–∏–ª–ª', 'health': '665', 'damage': '995', 'armor': '227', 'accuracy': '120', 'agility': '452', 'charisma': '151', 'bm': 2383, 'strategy': ['üõ° –ó–∞—â–∏—Ç–∞', 'üòé –ü—Ä–æ–≤–æ–∫–∞—Ü–∏—è', '‚öî –ù–∞–ø–∞–¥–µ–Ω–∏–µ'], 'band': 'üêá –ú–µ—Ä—Ç–≤—ã–µ –∫—Ä–æ–ª–∏–∫–∏'})
# competition.insert_one({'login': 'XyTop_2', 'chat': 497065022, 'date': 1571771071.300144, 'state': 'READY', 'name': '–ú–æ–Ω—Å—Ç—Ä', 'health': '665', 'damage': '995', 'armor': '227', 'accuracy': '120', 'agility': '452', 'charisma': '151', 'bm': 2383, 'strategy': ['‚öî –ù–∞–ø–∞–¥–µ–Ω–∏–µ', 'üòé –ü—Ä–æ–≤–æ–∫–∞—Ü–∏—è', 'üõ° –ó–∞—â–∏—Ç–∞'], 'band': 'üé© –ì–æ—Ä–æ–¥—Å–∫–∏–µ'})
# for x in competition.find():                                                 
#     print(x)

# dresult = battle.aggregate([
#                             {   "$match": {
#                                     "$and" : [
#                                         {
#                                             "band": "–ê—Ä—Ç—Ö–∞—É—Å"  
#                                         }]
#                                 }
#                             }, 
#                             {   "$group": {
#                                 "_id": "$winnerWarior", 
#                                 "count": {
#                                     "$sum": 1}}},
                                
#                             {   "$sort" : { "count" : -1 } }
#                             ])
# for x in dresult:
#     print(x)

    
# competition.delete_many({'login':'GonzikBenzyavsky3'})
# isReplay = False
# for x in competition.find({'login': 'GonzikBenzyavsky', 'chat': '12345678',   'state': { '$ne': '/^WAIT.*/' } }):                                                 
#     isReplay = True
#     break

# if not isReplay:
#     competition.insert_one({'login': 'GonzikBenzyavsky', 
#                             'chat': '12345678',
#                             'date': datetime.datetime.now().timestamp(), 
#                             'state': 'WAIT',
#                             'strategy': None})
 

# for x in competition.find():
#        print(x)
                            
# 
#     
#settings.delete_many({})
# for x in settings.find():
#        print(x)

# report = ''
# report = report + 'üèÜ–¢–û–ü –£–ë–ò–ô–¶ \n'
# report = report + '\n'
# setting = getSetting('REPORT_KILLERS')

# from_date = setting.get('from_date')
# to_date = setting.get('to_date')

# if (not from_date):
#     from_date = datetime.datetime(2019, 1, 1).timestamp() 
# else:
#     from_date = datetime.datetime.strptime(from_date, '%d/%m/%y').timestamp()

# if (not to_date):
#     to_date = datetime.datetime.now().timestamp()
# else:
#     to_date = datetime.datetime.strptime(to_date, '%d/%m/%y').timestamp()

# dresult = battle.aggregate([
#     {   "$match": { "date": {
#                 '$gte': from_date,
#                 '$lt': to_date
#             }
#         } 
#     }, 
#     {   "$group": {
#         "_id": "$winnerWarior", 
#         "count": {
#             "$sum": 1}}},
        
#     {   "$sort" : { "count" : -1 } }
#     ])

# findInWinner = False
# i = 0
# for d in dresult:
#     i = i + 1
#     if i == 1:
#         emoji = 'ü•á '
#     elif i == 2:
#         emoji = 'ü•à '    
#     elif i == 3:
#         emoji = 'ü•â '
#     else:
#         emoji = ''
#     user_name = d.get("_id")
#     if user_name == '–ö–∏—Ä–∏–ª–ª':
#         user_name = f'*{user_name}*'
#         findInWinner = True

#     report = report + f'{i}. {emoji}{user_name}: {d.get("count")}\n' 
#     if i == 10: break

# if (i == 0): 
#     report = report + f'–ú–∏—Ä! –ü–∏—Å! ‚úåÔ∏èüå∑üê£\n'
# else:
#     if (not findInWinner): report = report + f'üëπ –¢–µ–±—è –Ω–µ—Ç —Å—Ä–µ–¥–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –ø–∞—Ü–∞–Ω–æ–≤!\n'
    
# report = report + f'\n' 
# report = report + f'‚ö∞Ô∏è–¢–û–ü –ù–ï–£–î–ê–ß–ù–ò–ö–û–í' 
# dresult = battle.aggregate([
#     {   "$match": { "date": {
#                 '$gte': from_date,
#                 '$lt': to_date
#             }
#         } 
#     }, 
#     {   "$group": {
#         "_id": "$loseWarior", 
#         "count": {
#             "$sum": 1}}},
        
#     {   "$sort" : { "count" : -1 } }
#     ])

# findInLoser = False
# i = 0
# for d in dresult:
#     i = i + 1
#     if i == 1:
#         emoji = 'üëª '
#     elif i == 2:
#         emoji = 'üíÄÔ∏è '    
#     elif i == 3:
#         emoji = '‚ò†Ô∏è '
#     else:
#         emoji = ''
#     user_name = d.get("_id")
#     if user_name == '–ö–∏—Ä–∏–ª–ª':
#         user_name = f'*{user_name}*'
#         findInLoser = True

#     report = report + f'{i}. {emoji}{user_name}: {d.get("count")}\n' 
#     if i == 10: break

# if (i == 0): 
#     report = report + f'–ú—ã –±–µ—Å—Å–º–µ—Ä—Ç–Ω—ã ‚úåÔ∏èüëªüíÄ‚ò†Ô∏è\n'
# else:
#     if (findInWinner): report = report + f'üß∏ –¢—ã, –ª—É–∑–µ—Ä!\n'
# report = report + f'\n' 
# report = report + '‚è∞ c ' + time.strftime("%d-%m-%Y", time.gmtime(from_date)) + ' –ø–æ ' + time.strftime("%d-%m-%Y %H:%M:%S", time.gmtime(to_date))

# print(report)

# battle.insert_one({'login': 'monzik', 'date': datetime.now().timestamp(), 'winnerWarior': 'Win1', 'loseWarior': 'lose'})
# battle.insert_one({'login': 'konzik', 'date': datetime.now().timestamp(), 'winnerWarior': 'Win1', 'loseWarior': 'lose'})
# battle.insert_one({'login': 'GonzikBenzyavsky', 'date': datetime.now().timestamp(), 'winnerWarior': '–ö–∏—Ä–∏–ª–ª', 'loseWarior': 'lose1'})
# battle.insert_one({'login': 'GonzikBenzyavsky', 'date': datetime.now().timestamp(), 'winnerWarior': 'lose1', 'loseWarior': '–ö–∏—Ä–∏–ª–ª'})
# battle.insert_one({'login': 'GonzikBenzyavsky', 'date': datetime.now().timestamp(), 'winnerWarior': '–ö–∏—Ä–∏–ª–ª', 'loseWarior': 'lose1'})
# battle.insert_one({'login': 'konzik', 'date': datetime.now().timestamp(), 'winnerWarior': 'lose', 'loseWarior': 'Win1'})
# battle.insert_one({'login': 'tonzik', 'date': datetime.now().timestamp(), 'winnerWarior': 'lose', 'loseWarior': 'Win1'})

# for x in registered_wariors.find():
#        print(x)

# print("==================================================")

# for x in registered_wariors.find({'name':{'$regex':'–∏—Ä–∏', '$options':'i'}}):
#    print(x.get('name'))

# myquery = {}
# newvalues = { "$set": { "photo": None } }
# x = registered_wariors.update_many(myquery, newvalues)

# text = u'üìü–ü–∏–ø-–±–æ–π 3000 v2.2b1\n–ù–∞—á–∞–ª–æ—Å—å –∏–≥—Ä–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ\n\"–õ–µ–≥–∫–∏–µ –Ω–∞ –ø–æ–¥—ä–µ–º\"\nArk–∞, üí£–ú–µ–≥–∞—Ç–æ–Ω–Ω–∞\nü§ü–ë–∞–Ω–¥–∞: –ê—Ä—Ç—Ö–∞—É—Å\n‚ù§Ô∏è–ó–¥–æ—Ä–æ–≤—å–µ: 1103/969\n‚ò†Ô∏è–ì–æ–ª–æ–¥: 100% /myfood\n‚öîÔ∏è–£—Ä–æ–Ω: 1272 üõ°–ë—Ä–æ–Ω—è: 260\n\nüí™–°–∏–ª–∞: 928 üéØ–ú–µ—Ç–∫–æ—Å—Ç—å: 63\nüó£–•–∞—Ä–∏–∑–º–∞: 54 ü§∏üèΩ‚Äç‚ôÇÔ∏è–õ–æ–≤–∫–æ—Å—Ç—å: 526\n\nüîã–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å: 18/21 /ref\nüìç–®–∫–æ–ª–∞, üë£45–∫–º. \n\n–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞:\n–î–≤—É—Å—Ç–≤–æ–ª—å–Ω–æ–µ —Ä—É–∂—å–µ \nüõ†–ú—É–ª—å—Ç–∏–∑–∞—â–∏—Ç–∞üîÜ +168üõ° üîß99%\nüõ†–ö–æ—Å—Ç—è–Ω–æ–π —à–ª–µ–º +92üõ° üîß77%\nüß†–ë—Ä–µ–π–Ω–∞–ª–∞–π–∑–µ—Ä +344‚öîÔ∏è üîß100%\nüì•–ú–æ–¥—É–ª—å —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏\n\n–†–µ—Å—É—Ä—Å—ã:\nüï≥–ö—Ä—ã—à–∫–∏: 18874 \nüì¶–ú–∞—Ç–µ—Ä–∏–∞–ª—ã: 24519\nüíà–ü—É–ø—Å—ã: 2 /thanks\nüèÜ–†–µ–π—Ç–∏–Ω–≥ /wwtop\n\n–†–µ–ø—É—Ç–∞—Ü–∏—è:\n–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π\nüèµ2 ‚ñì‚ñì‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë\nID256292161\n\n–†–µ–π–¥ –≤ 17:00 16.9:\n–°—Ç–∞—Ä–∞—è —Ñ–∞–±—Ä–∏–∫–∞\n üï≥+1792 üì¶+2688 üì¶+0'
# text = '‚öõÔ∏è ‚ú¥ Alfakill –∏ –µ–≥–æ üõ∞–®–µ—Ä–ª–æ–∫–¥—Ä–æ–Ω.\nü§ò(–±–µ–∑ –±–∞–Ω–¥—ã)\n‚öîÔ∏è /p_I2CL'
# text = '‚öôÔ∏è Laughing_Bright\nüêêPro100KAPIBARY ü§ò–¢—É–Ω–Ω–µ–ª—å–Ω—ã–µ –∑–º–µ–∏\n‚öîÔ∏è /p_UOMB'

# i = 0
# strings = text.split('\n')
# isEquipequipment = False
# for s in strings:
#    print(strings[i].split(' ')[0])
#    if (strings[i].startswith('‚öõÔ∏è')) : print('–£—Ä–∞!')
#    if (strings[i].startswith('‚öôÔ∏è')) : print('–£—Ä–∞!2')
   
#    i = i + 1

# i = 0
# strings = text.split('\n')
# isEquipequipment = False
# for s in strings:
#     if ('üèµ' in strings[i]):
#         dzen_tmp = strings[i][1:2].strip()
#         if dzen_tmp == '':
#             print('Dzen = 0')
#         elif (int(dzen_tmp) >=2):
#             print(str(int(dzen_tmp)-1))
        
#     # print(str(i)+' - |'+s+'|')
#     i=i+1

    
# for target_list in USERS:
#     print(target_list.get('login'))
# for registered_user in registered_users.find({"login": f"XyTop_2"}):
#     print(registered_user)

# registered_users.remove()
# registered_wariors.remove()
# try_counters.remove()
